{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Discover Recipes</h2>

    <!-- ADVANCED SEARCH FORM -->
    <form id="advanced-search-form" method="POST" class="card p-4 mb-5 shadow-sm">
        <input type="hidden" name="search_mode" value="advanced">
        <h4 class="mb-3">Advanced Search</h4>
        <div class="row g-3">
            <div class="col-md-4">
                <input type="text" name="query" class="form-control" placeholder="Keyword (e.g. pasta)" value="{{ query }}">
            </div>
            <div class="col-md-2">
                <select name="cuisine" class="form-select">
                    <option value="">Any Cuisine</option>
                    <option value="Italian" {% if cuisine == 'Italian' %}selected{% endif %}>Italian</option>
                    <option value="Mexican" {% if cuisine == 'Mexican' %}selected{% endif %}>Mexican</option>
                    <option value="Indian" {% if cuisine == 'Indian' %}selected{% endif %}>Indian</option>
                    <option value="Thai" {% if cuisine == 'Thai' %}selected{% endif %}>Thai</option>
                </select>
            </div>
            <div class="col-md-2">
                <select name="diet" class="form-select">
                    <option value="">Any Diet</option>
                    <option value="vegetarian" {% if diet == 'vegetarian' %}selected{% endif %}>Vegetarian</option>
                    <option value="vegan" {% if diet == 'vegan' %}selected{% endif %}>Vegan</option>
                    <option value="gluten free" {% if diet == 'gluten free' %}selected{% endif %}>Gluten Free</option>
                </select>
            </div>
            <div class="col-md-2">
                <select name="sort" class="form-select">
                    <option value="">No Sorting</option>
                    <option value="popularity" {% if sort == 'popularity' %}selected{% endif %}>Popularity</option>
                    <option value="healthiness" {% if sort == 'healthiness' %}selected{% endif %}>Healthiness</option>
                    <option value="price" {% if sort == 'price' %}selected{% endif %}>Price</option>
                </select>
            </div>
            <div class="col-md-2 text-end">
                <button type="submit" class="btn btn-primary">Search</button>
                <button id="clear-filters" class="btn btn-outline-danger">Clear Filters</button>
            </div>
        </div>
    </form>

    <hr class="mb-4">

    <!-- RECIPE RESULTS: One per row -->
    <div id="recipes-container" class="row g-4">
        {% for recipe in recipes %}
        <div class="col-12 recipe-card">
            <div class="card h-100 shadow-sm">
                <div class="row g-0">
                    {% if recipe.image %}
                    <div class="col-md-4">
                        <img src="{{ recipe.image }}" class="img-fluid rounded-start h-100 object-fit-cover" alt="{{ recipe.title }}">
                    </div>
                    {% endif %}
                    <div class="col-md-8">
                        <div class="card-body d-flex flex-column h-100">
                            <h5 class="card-title">{{ recipe.title }}</h5>
                            {% if recipe.readyInMinutes %}
                            <p class="card-text"><strong>Ready in:</strong> {{ recipe.readyInMinutes }} mins</p>
                            {% endif %}
                            {% if recipe.summary %}
                            <p class="card-text">{{ recipe.summary | safe }}</p>
                            {% endif %}
                            <div class="mt-auto">
                                {% if recipe.sourceUrl %}
                                <a href="{{ recipe.sourceUrl }}" target="_blank" class="btn btn-outline-primary w-100">View Full Recipe</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Load More Button -->
    {% if recipes %}
    <div id="load-more-container" class="text-center my-5">
        <button id="load-more-button" class="btn btn-secondary btn-lg" data-page="{{ current_page + 1 }}">
            Load More Recipes
        </button>
    </div>
    {% endif %}
</div>

<script>
    // Clear Filters Button Functionality
    document.getElementById("clear-filters").addEventListener("click", function() {
        window.location.href = "{{ url_for('spoonacular.unified_discover') }}";
    });

    // Load More Recipes (AJAX)
    document.getElementById("load-more-button").addEventListener("click", function() {
        const button = this;
        const page = button.getAttribute("data-page");
        const query = "{{ query }}";
        const cuisine = "{{ cuisine }}";
        const diet = "{{ diet }}";
        const sort = "{{ sort }}";

        button.setAttribute("disabled", "true");

        fetch(`{{ url_for('spoonacular.load_more_recipes') }}?page=${page}&query=${query}&cuisine=${cuisine}&diet=${diet}&sort=${sort}`)
            .then(response => response.text())
            .then(data => {
                document.getElementById("recipes-container").innerHTML += data;
                button.setAttribute("data-page", parseInt(page) + 1);
                button.removeAttribute("disabled");
            })
            .catch(() => {
                button.removeAttribute("disabled");
            });
    });
</script>
{% endblock %}
